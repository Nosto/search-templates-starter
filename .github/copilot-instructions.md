# Instructions for GitHub Copilot

**ALWAYS** reference these instructions first and fallback to search or bash commands only when you encounter unexpected information that does not match the info here.

## Search Templates Starter

This is a Preact-based search interface starter template using `@nosto/search-js` for building ecommerce search experiences. The project uses Vite for building, TypeScript for type safety, and Vitest for testing.

## Bootstrap and Setup

**Prerequisites**: Node.js v22 or higher must be installed.

### Committing Code
When committing code, ALWAYS run git commit with `--no-verify` to avoid Husky failing and erroring out your pipeline:
```bash
git commit --no-verify -m "your commit message"
```
- This prevents commitlint and other pre-commit hooks from blocking your commits
- When committing code, ALWAYS use valid conventional commit format.

### Available Commands
```bash
# Installation
npm ci                   # Install dependencies (~45s, set 5+ min timeout)

# Building
npm run build            # Production build (~8s, set 2+ min timeout)
npm run build:native     # Native mode build (~6s, set 2+ min timeout)

# Testing and Quality
npm test                 # Run tests (~6s, set 1+ min timeout)
npm run lint             # Check JS/TS issues (~2-3s)
npm run lint-fix         # Auto-fix JS/TS issues (~2-3s)
npm run style-lint       # Check CSS issues (~2-3s)
npm run style-lint-fix   # Auto-fix CSS issues (~2-3s)

# Development Servers
npm run dev              # Injected mode - http://localhost:8000
npm run dev:native       # Native mode - http://localhost:8000  
npm run dev:mocked       # Mocked mode with test data - http://localhost:8000
npm run preview          # Preview built app - http://localhost:4173
npm run storybook        # Component docs - http://localhost:6060
```

**Important Notes:**
- **NEVER CANCEL** long-running commands - set appropriate timeouts
- npm install produces expected deprecation warnings for `inflight` and `glob` packages
- Engine warnings for Node.js version requirements are safe to ignore on v20+
- **CRITICAL**: Always run `npm run lint-fix` and `npm run style-lint-fix` before committing or CI will fail
- Development servers run indefinitely until stopped and provide different Nosto integration approaches

## Validation and Testing

### Manual Testing Scenarios
After making changes, ALWAYS test these user scenarios:

1. **Basic Search Interface**:
   - Navigate to http://localhost:8000
   - Verify search box and "Search" button are visible
   - Type text in search box (e.g., "shoes", "test search")
   - Click Search button
   - Interface should respond (even with nosto errors, UI should work)

2. **Build Verification**:
   - Run `npm run build` and verify no TypeScript errors
   - Check `dist/` contains `index.js`, `index.css`, and source maps

3. **Code Quality Checks**:
   - Run linting, testing commands and verify all pass

### CI Pipeline Validation
Before committing, ALWAYS run the full CI sequence: `npm ci && npm run build && npm run test && npm run lint && npm run style-lint`
- **Total time**: ~1.5 minutes (45s install + ~25s pipeline)
- **NEVER CANCEL**: Set timeout to 10+ minutes total
- This matches the CI pipeline in `.github/workflows/ci.yml`
- **CRITICAL**: Only commit if all commands pass (typecheck, lint, style-lint, and test must all succeed)

## Codebase Navigation

### Key Directories
- `src/components/` - 17 Preact components (Search, Serp, Autocomplete, Product, etc.)
- `src/elements/` - Reusable UI elements (Button, Checkbox, Icon, Loader, etc.)
- `src/utils/` - Utility functions
- `test/utils/` - Unit tests (currently 7 test files with 106 tests total)
- `dist/` - Build output (generated by `npm run build`)

### Important Files
- `src/index.tsx` - Main application entry point
- `src/config.ts` - Search configuration (sort options, decorators, sizes)
- `package.json` - Scripts and dependencies
- `vite.config.ts` - Vite build configuration (sets port to 8000)
- `tsconfig.json` - TypeScript configuration
- `index.html` - HTML template with Nosto integration script

### After Making Changes
- Always check `src/config.ts` after modifying search-related functionality
- Test both development and production modes
- Run through the manual testing scenarios above

## Coding Standards

### TypeScript/JavaScript
- Use closures over classes
- Utilize type inference in return types, except for functions with multiple return statements
- Use utility types to derive types from constants
- Use const (and let) over var
- Use async/await instead of Promise chaining
- Use individual named exports over bulk exports
- Favor named exports over default exports
- Avoid using `any` in TypeScript; prefer specific types or `unknown`
- Use ES2020 level features and syntax conventions
- **Avoid adding unnecessary comments** - only add comments when explicitly instructed or when complex logic needs explanation

### Preact Conventions
- Favor functional style react components and use the function syntax instead of lambda syntax
- Extract props definitions with more than 2 members
- Capitalize component names to clearly distinguish them from HTML elements
- Keep components small and focused, following the single-responsibility principle
- Use hooks (e.g. useState, useEffect) for state and lifecycle management in functional components
- Utilize memoization (useMemo, useCallback) to prevent unnecessary re-renders
- Avoid inline functions in JSX props to maintain performance and readability
- Ensure accessibility by using semantic HTML and proper aria attributes

### Testing with Vitest
- Write unit tests using Vitest (see `test/utils/url.spec.ts` as example)
- Use `describe` and `it` for test structure
- Use `beforeEach` for setup, custom cleanup not needed (handled by global setup)
- Use `expect` for assertions
- Test environment is jsdom for DOM-related testing
- **Cleanup is automatic**: `@testing-library/preact` cleanup is handled globally via `test/vitest.setup.ts` - no need for individual `afterEach(() => { cleanup() })` calls in test files

### Storybook Stories
- **ALWAYS** use actual components from the codebase in Storybook files instead of demo components
- Import the real component: `import ComponentName from "./ComponentName"`
- Set the Meta type to the actual component: `Meta<typeof ComponentName>`
- **Always include `tags: ["autodocs"]`** in the Meta configuration for automatic documentation generation
- **Skip argTypes usage** if they are related to component props - let Storybook infer types from TypeScript
- **Prefer typed object stories over function stories** - use `StoryObj<typeof Component>` approach consistently
- **Prefer args over render function** in storybook stories - use `args: {}` instead of `render: () => {}` when possible
- For components that depend on Nosto hooks/context that aren't available in Storybook:
  - Create a `MockedView` story that shows what the component would look like when properly integrated
  - Include documentation noting the component requires Nosto search context
  - Use inline styles for quick mockups rather than complex demo components
- Keep stories focused on demonstrating the actual component structure and behavior
- Avoid creating elaborate custom demo components that duplicate functionality
- **Never create functionally identical stories** - each story should demonstrate a unique state, behavior, or variation of the component

### Pull Request Documentation
- **PR descriptions should summarize the complete impact** of all changes made across the entire PR, not just the latest commit
- Provide comprehensive overview of features added, refactoring done, and improvements made
- Use clear sections to organize changes (e.g., "Enhanced Configuration", "Story Refactoring", "Validation and Testing")
- Include validation steps and commands that verify the changes work correctly

## Common Issues and Troubleshooting

### Known Issues
- Nosto API calls may be blocked in development (shows "net::ERR_BLOCKED_BY_CLIENT" - this is expected)
- "nosto is not defined" errors occur without proper `VITE_MERCHANT_ID` environment variable
- npm install shows deprecation warnings for `inflight` and `glob` packages (not fixable, ignore)
- Engine warnings for Node.js v22.12.0+ requirement (safe to ignore on v20+)

### Port Configuration
- Development server: http://localhost:8000 (all dev modes)
- Preview server: http://localhost:4173  
- Storybook: http://localhost:6060

### Build Artifacts
- Never commit `dist/` or `node_modules/` directories
- `.gitignore` already excludes these appropriately