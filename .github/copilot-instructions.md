# Instructions for GitHub Copilot

**ALWAYS** reference these instructions first and fallback to search or bash commands only when you encounter unexpected information that does not match the info here.

## Search Templates Starter

This is a Preact-based search interface starter template using `@nosto/search-js` for building ecommerce search experiences. The project uses Vite for building, TypeScript for type safety, and Vitest for testing.

## Bootstrap and Setup

**Prerequisites**: Node.js v22 or higher must be installed.

### Install Dependencies
```bash
npm ci
```
- **Time**: ~2 minutes 15 seconds with clean cache
- **NEVER CANCEL**: Set timeout to 5+ minutes for slow networks
- Note: Produces deprecation warnings for `inflight` and `glob` packages (expected)
- May show 2 vulnerabilities (1 low, 1 critical) - these are from dependencies

### Build Project
```bash
npm run build
```
- **Time**: ~8 seconds (includes TypeScript compilation, Vite bundling, and TypeDoc generation)
- **NEVER CANCEL**: Set timeout to 2+ minutes
- Generates:
  - `dist/` directory with bundled assets (`index.js`, `index.css`, source maps)
  - `docs/` directory with TypeDoc documentation

### Run Tests
```bash
npm test
```
- **Time**: ~2 seconds (runs 7 tests in 1 file)
- **NEVER CANCEL**: Set timeout to 1+ minute
- Uses Vitest with jsdom environment

### Run Linting
```bash
npm run lint        # Check for issues
npm run lint-fix    # Auto-fix issues
```
- **Time**: ~2-3 seconds each
- **CRITICAL**: Always run `npm run lint-fix` before committing or CI will fail

## Validation and Testing

### Manual Testing Scenarios
After making changes, ALWAYS test these user scenarios:

1. **Basic Search Interface**:
   - Navigate to http://localhost:8000
   - Verify search box and "Search" button are visible
   - Type text in search box (e.g., "shoes", "test search")
   - Click Search button
   - Interface should respond (even with nosto errors, UI should work)

2. **Build Verification**:
   - Run `npm run build` and verify no TypeScript errors
   - Check `dist/` contains `index.js`, `index.css`, and source maps
   - Check `docs/` contains generated TypeDoc documentation

3. **Code Quality Checks**:
   - Run `npm run lint` and verify no linting errors
   - Run `npm test` and verify all tests pass

### CI Pipeline Validation
Before committing, ALWAYS run these commands in sequence:
```bash
npm ci
npm run build
npm run test
npm run lint
```
- **Total time**: ~2.5 minutes
- **NEVER CANCEL**: Set timeout to 10+ minutes total
- This matches the CI pipeline in `.github/workflows/ci.yml`
- **CRITICAL**: Only commit if all commands pass (typecheck, lint, and test must all succeed)

### Committing Code
When committing code, ALWAYS run git commit with `--no-verify` to avoid Husky failing and erroring out your pipeline:
```bash
git commit --no-verify -m "your commit message"
```
- This prevents commitlint and other pre-commit hooks from blocking your commits
- When committing code, ALWAYS use valid conventional commit format.

## Codebase Navigation

### Key Directories
- `src/components/` - 14 Preact components (Search, Serp, Autocomplete, Product, etc.)
- `src/elements/` - Reusable UI elements (Button, Checkbox, Icon, Loader, etc.)
- `src/utils/` - Utility functions (includes `cl` classname helper)
- `test/utils/` - Unit tests (currently 1 test file for `cl` utility)
- `dist/` - Build output (generated by `npm run build`)
- `docs/` - TypeDoc documentation (generated by `npm run build`)

### Important Files
- `src/index.tsx` - Main application entry point
- `src/config.ts` - Search configuration (sort options, decorators, sizes)
- `package.json` - Scripts and dependencies
- `vite.config.ts` - Vite build configuration (sets port to 8000)
- `tsconfig.json` - TypeScript configuration
- `index.html` - HTML template with Nosto integration script

### After Making Changes
- Always check `src/config.ts` after modifying search-related functionality
- Test both development (`npm run dev`) and production (`npm run build && npm run preview`) modes
- Run through the manual testing scenarios above

## Coding Standards

### TypeScript/JavaScript
- Use closures over classes
- Utilize type inference in return types, except for functions with multiple return statements
- Use utility types to derive types from constants
- Use const (and let) over var
- Use async/await instead of Promise chaining
- Use individual named exports over bulk exports
- Favor named exports over default exports
- Avoid using `any` in TypeScript; prefer specific types or `unknown`
- Use ES2020 level features and syntax conventions
- **Avoid adding unnecessary comments** - only add comments when explicitly instructed or when complex logic needs explanation

### Preact Conventions
- Favor functional style react components and use the function syntax instead of lambda syntax
- Extract props definitions with more than 2 members
- Capitalize component names to clearly distinguish them from HTML elements
- Keep components small and focused, following the single-responsibility principle
- Use hooks (e.g. useState, useEffect) for state and lifecycle management in functional components
- Utilize memoization (useMemo, useCallback) to prevent unnecessary re-renders
- Avoid inline functions in JSX props to maintain performance and readability
- Ensure accessibility by using semantic HTML and proper aria attributes

### Testing with Vitest
- Write unit tests using Vitest (see `test/utils/cl.spec.ts` as example)
- Use `describe` and `it` for test structure
- Use `beforeEach` for setup, `afterEach` for cleanup
- Use `expect` for assertions
- Test environment is jsdom for DOM-related testing

### Storybook Stories
- **ALWAYS** use actual components from the codebase in Storybook files instead of demo components
- Import the real component: `import ComponentName from "./ComponentName"`
- Set the Meta type to the actual component: `Meta<typeof ComponentName>`
- For components that depend on Nosto hooks/context that aren't available in Storybook:
  - Create a `MockedView` story that shows what the component would look like when properly integrated
  - Include documentation noting the component requires Nosto search context
  - Use inline styles for quick mockups rather than complex demo components
- Keep stories focused on demonstrating the actual component structure and behavior
- Avoid creating elaborate custom demo components that duplicate functionality

### Pull Request Documentation
- **PR descriptions should summarize the complete impact** of all changes made across the entire PR, not just the latest commit
- Provide comprehensive overview of features added, refactoring done, and improvements made
- Use clear sections to organize changes (e.g., "Enhanced Configuration", "Story Refactoring", "Validation and Testing")
- Include validation steps and commands that verify the changes work correctly

## Common Issues and Troubleshooting

### Known Issues
- Nosto API calls may be blocked in development (shows "net::ERR_BLOCKED_BY_CLIENT" - this is expected)
- "nosto is not defined" errors occur without proper `VITE_MERCHANT_ID` environment variable
- npm install shows deprecation warnings for `inflight` and `glob` packages (not fixable, ignore)
- Dependency vulnerabilities reported by npm audit (from third-party packages)

### Port Configuration
- Preview server runs on port 4173

### Build Artifacts
- Never commit `dist/`, `docs/`, or `node_modules/` directories
- `.gitignore` already excludes these appropriately